<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç”Ÿç”¢æ—¥å ±è¡¨ä¿®æ”¹ç”³è«‹ç³»çµ±</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ­ ç”Ÿç”¢æ—¥å ±è¡¨ä¿®æ”¹ç”³è«‹ç³»çµ±</h1>
      <p>æŸ¥è©¢ã€ä¿®æ”¹ã€å„²å­˜èˆ‡åˆ—å°ç”Ÿç”¢æ—¥å ±è¡¨è³‡æ–™</p>
    </div>

    <div class="content">
      <!-- æœå°‹å€åŸŸ -->
      <div class="search-section">
        <form class="search-form" onsubmit="searchData(event)">
          <div class="form-group">
            <label for="dySerialNum">ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿ</label>
            <input
              type="text"
              id="dySerialNum"
              name="dySerialNum"
              placeholder="ä¾‹å¦‚: DY20260128094"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è©¢</button>
        </form>
      </div>

      <!-- è¨Šæ¯æç¤º -->
      <div id="alert" class="alert"></div>

      <!-- è¼‰å…¥å‹•ç•« -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>è³‡æ–™æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</p>
      </div>

      <!-- çµæœå€åŸŸ -->
      <div id="resultSection" class="result-section" style="display: none;">
        <div class="result-header">
          <h2>ğŸ“Š æŸ¥è©¢çµæœèˆ‡ä¿®æ”¹</h2>
          <div class="result-info">
            å…± <span id="recordCount">0</span> ç­†è³‡æ–™
          </div>
        </div>

        <!-- åˆªé™¤é¸é … -->
        <div class="delete-section">
          <label class="checkbox-label">
            <input type="checkbox" id="deleteFlag" onchange="handleDeleteToggle()" />
            <span>æ•´å¼µç”Ÿç”¢æ—¥å ±è¡¨åˆªé™¤</span>
          </label>
          <span class="delete-hint">ï¼ˆå‹¾é¸å¾Œï¼Œä¿®æ”¹æ¬„ä½å°‡è¢«åœç”¨ï¼‰</span>
        </div>

        <div id="cardsContainer" class="prs-cards"></div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="action-buttons">
          <button type="button" class="btn btn-success" onclick="saveModification()" id="saveBtn">
            ğŸ’¾ å„²å­˜
          </button>
          <button type="button" class="btn btn-info" onclick="uploadFiles()" id="uploadBtn" style="display: none;">
            ğŸ“¤ ä¸Šå‚³è‡³ç¶²è·¯è³‡æ–™å¤¾
          </button>
          <button type="button" class="btn btn-warning" onclick="printQueue()" id="printBtn" style="display: none;">
            ğŸ–¨ï¸ åˆ—å°
          </button>
        </div>

        <!-- ä¿®æ”¹ç”³è«‹æ¸…å–®ï¼ˆæ¢åˆ—å¼ï¼‰ -->
        <div class="print-queue-section" id="printQueueSection" style="display: none;">
          <div class="queue-header">
            <h3>ğŸ“‹ ä¿®æ”¹ç”³è«‹æ¸…å–®</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="clearQueue()" id="clearQueueBtn">
              ğŸ—‘ï¸ å…¨éƒ¨åˆªé™¤
            </button>
          </div>
          <div class="queue-list" id="queueList">
            <!-- å‹•æ…‹ç”Ÿæˆåˆ—è¡¨é …ç›® -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentData = null;
    let currentDateType = null; // 'same_day' æˆ– 'different_day'

    // å¯è¼¸å…¥ä¿®æ”¹çš„æ¬„ä½
    const EDITABLE_LABELS = new Set([
      'å·¥ä½œæ—¥æœŸ',
      'å·¥åºç·¨è™Ÿ',
      'æ©Ÿå°ç·¨è™Ÿ',
      'å·¥ä½œè€…ç·¨è™Ÿ',
      'å®Œå·¥æ•¸',
      'ä¸è‰¯æ•¸',
      'èµ·å·¥æ™‚é–“',
      'å®Œå·¥æ™‚é–“',
      'é™¤å¤–åç¨±1',
      'é™¤å¤–åç¨±2',
      'é™¤å¤–åç¨±3',
      'é™¤å¤–æ™‚é–“1',
      'é™¤å¤–æ™‚é–“2',
      'é™¤å¤–æ™‚é–“3',
    ]);

    // åˆ¤æ–·å·¥ä½œæ—¥æœŸæ˜¯å¦ç‚ºç•¶å¤©
    function isSameDay(workDate) {
      if (!workDate) {
        console.log('[isSameDay] workDate ç‚ºç©º');
        return false;
      }
      
      // ä½¿ç”¨æœ¬åœ°æ™‚å€ï¼Œä¸ä½¿ç”¨ UTC
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const todayStr = `${year}-${month}-${day}`; // YYYY-MM-DD
      
      console.log('[isSameDay] ä»Šå¤©æ—¥æœŸï¼ˆæœ¬åœ°æ™‚å€ï¼‰:', todayStr);
      
      // è™•ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
      let workDateStr = '';
      if (typeof workDate === 'string') {
        // å¦‚æœæ˜¯å­—ä¸²ï¼Œå˜—è©¦è½‰æ›ç‚º YYYY-MM-DD æ ¼å¼
        if (workDate.includes('/')) {
          // æ ¼å¼å¦‚ 2026/02/01
          const parts = workDate.split('/');
          if (parts.length === 3) {
            workDateStr = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
          }
        } else if (workDate.includes('-')) {
          // æ ¼å¼å¦‚ 2026-02-01 æˆ– 2026-02-01 03:16:30
          workDateStr = workDate.split(' ')[0]; // å»é™¤æ™‚é–“éƒ¨åˆ†
        } else {
          workDateStr = workDate;
        }
      }
      
      console.log('[isSameDay] å·¥ä½œæ—¥æœŸ:', workDateStr);
      console.log('[isSameDay] æ˜¯å¦ç›¸åŒ:', workDateStr === todayStr);
      
      return workDateStr === todayStr;
    }

    // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹ï¼ˆæ ¹æ“šæ¸…å–®ä¸­çš„è¨˜éŒ„é¡å‹ï¼‰
    async function updateButtonVisibility(currentRecordDateType = null) {
      const uploadBtn = document.getElementById('uploadBtn');
      const printBtn = document.getElementById('printBtn');
      
      try {
        // ç²å–æ¸…å–®ä¸­ç•¶å¤©å’Œéç•¶å¤©è¨˜éŒ„çš„æ•¸é‡
        const response = await fetch('/api/get_queue_types');
        const data = await response.json();
        
        console.log('Queue types:', data); // èª¿è©¦ç”¨
        
        if (data.success) {
          const hasSameDay = data.same_day_count > 0;
          const hasDifferentDay = data.different_day_count > 0;
          
          console.log('hasSameDay:', hasSameDay, 'hasDifferentDay:', hasDifferentDay); // èª¿è©¦ç”¨
          
          if (hasSameDay && hasDifferentDay) {
            // æ··åˆæƒ…å¢ƒï¼šå…©å€‹æŒ‰éˆ•éƒ½é¡¯ç¤º
            console.log('æ··åˆæƒ…å¢ƒï¼šé¡¯ç¤ºå…©å€‹æŒ‰éˆ•'); // èª¿è©¦ç”¨
            uploadBtn.style.display = 'inline-block';
            uploadBtn.innerHTML = 'ğŸ“¤ ä¸Šå‚³è‡³ç¶²è·¯è³‡æ–™å¤¾ï¼ˆä¸éœ€ç°½æ ¸ï¼‰';
            uploadBtn.disabled = false;
            
            printBtn.style.display = 'inline-block';
            printBtn.innerHTML = 'ğŸ–¨ï¸ åˆ—å°ï¼ˆéœ€ä¸»ç®¡ç°½æ ¸ï¼‰';
            printBtn.disabled = false;
            
          } else if (hasSameDay) {
            // åªæœ‰ç•¶å¤©è¨˜éŒ„ï¼šé¡¯ç¤ºä¸Šå‚³æŒ‰éˆ•
            console.log('åªæœ‰ç•¶å¤©è¨˜éŒ„'); // èª¿è©¦ç”¨
            uploadBtn.style.display = 'inline-block';
            uploadBtn.innerHTML = 'ğŸ“¤ ä¸Šå‚³è‡³ç¶²è·¯è³‡æ–™å¤¾ï¼ˆä¸éœ€ç°½æ ¸ï¼‰';
            uploadBtn.disabled = false;
            
            printBtn.style.display = 'none';
            
          } else if (hasDifferentDay) {
            // åªæœ‰éç•¶å¤©è¨˜éŒ„ï¼šé¡¯ç¤ºåˆ—å°æŒ‰éˆ•
            console.log('åªæœ‰éç•¶å¤©è¨˜éŒ„'); // èª¿è©¦ç”¨
            uploadBtn.style.display = 'none';
            
            printBtn.style.display = 'inline-block';
            printBtn.innerHTML = 'ğŸ–¨ï¸ åˆ—å°ï¼ˆéœ€ä¸»ç®¡ç°½æ ¸ï¼‰';
            printBtn.disabled = false;
            
          } else {
            // æ¸…å–®ç‚ºç©ºï¼šæ ¹æ“šç•¶å‰æŸ¥è©¢çš„è¨˜éŒ„é¡å‹é¡¯ç¤º
            console.log('æ¸…å–®ç‚ºç©º'); // èª¿è©¦ç”¨
            if (currentRecordDateType === 'same_day') {
              uploadBtn.style.display = 'inline-block';
              uploadBtn.innerHTML = 'ğŸ“¤ ä¸Šå‚³è‡³ç¶²è·¯è³‡æ–™å¤¾ï¼ˆä¸éœ€ç°½æ ¸ï¼‰';
              printBtn.style.display = 'none';
            } else if (currentRecordDateType === 'different_day') {
              uploadBtn.style.display = 'none';
              printBtn.style.display = 'inline-block';
              printBtn.innerHTML = 'ğŸ–¨ï¸ åˆ—å°ï¼ˆéœ€ä¸»ç®¡ç°½æ ¸ï¼‰';
            } else {
              // æ²’æœ‰æŸ¥è©¢è¨˜éŒ„ï¼Œéš±è—æ‰€æœ‰æŒ‰éˆ•
              uploadBtn.style.display = 'none';
              printBtn.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å¤±æ•—:', error);
      }
    }

    // é¡¯ç¤ºæ¬„ä½å®šç¾©
    const FIELDS = [
      { label: 'ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿ', keys: ['ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿ','ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿç¢¼','dySerialNum','æ—¥å ±åºè™Ÿ'] },
      { label: 'å·¥ä½œæ—¥æœŸ',       keys: ['å·¥ä½œæ—¥æœŸ','æ—¥æœŸ'] },
      { label: 'å·¥ä½œè€…ç·¨è™Ÿ',     keys: ['å·¥ä½œè€…ç·¨è™Ÿ','å·¥ä½œè€…ä»£è™Ÿ','äººå“¡ä»£è™Ÿ','å“¡å·¥ç·¨è™Ÿ'] },
      { label: 'å·¥ä½œè€…åç¨±',     keys: ['å·¥ä½œè€…åç¨±','å·¥ä½œè€…','äººå“¡åç¨±','å“¡å·¥å§“å'] },

      { label: 'å·¥åºç·¨è™Ÿ',       keys: ['å·¥åºä»£è™Ÿ','å·¥åºç·¨è™Ÿ'] },
      { label: 'å·¥åºå…§å®¹',       keys: ['å·¥åºå…§å®¹','å·¥åºèªªæ˜','å·¥åºåç¨±'] },
      { label: 'ç™¼å·¥å–®è™Ÿ',       keys: ['ç™¼å·¥å–®è™Ÿ','å·¥å–®è™Ÿ','å·¥å–®'] },
      { label: 'è£½ä»¤åºè™Ÿ',       keys: ['è£½ä»¤åºè™Ÿ','è£½ä»¤','è£½ä»¤è™Ÿ','è£½ä»¤ç·¨è™Ÿ'] },

      { label: 'ç”¢å“ç·¨è™Ÿ',       keys: ['ç”¢å“ç·¨è™Ÿ','å“è™Ÿ','å“ç•ª','æ–™è™Ÿ'] },
      { label: 'å“åè¦æ ¼',       keys: ['å“åè¦æ ¼','å“å','è¦æ ¼','å“å/è¦æ ¼'] },
      { label: 'èµ·å·¥å‹æ…‹',       keys: ['èµ·å·¥å‹æ…‹','èµ·å·¥ç‹€æ…‹','ç‹€æ…‹'] },
      { label: 'èµ·å·¥æ™‚é–“',       keys: ['èµ·å·¥æ™‚é–“','èµ·å·¥','é–‹å§‹æ™‚é–“','é–‹å·¥æ™‚é–“'] },

      { label: 'å®Œå·¥æ™‚é–“',       keys: ['å®Œå·¥æ™‚é–“','å®Œå·¥','çµæŸæ™‚é–“'] },
      { label: 'æ©Ÿå°ç·¨è™Ÿ',       keys: ['æ©Ÿå°ç·¨è™Ÿ','æ©Ÿå°','è¨­å‚™ç·¨è™Ÿ'] },
      { label: 'æ©Ÿå°éƒ¨é–€',       keys: ['æ©Ÿå°éƒ¨é–€','éƒ¨é–€','ç”¢ç·š','ç·šåˆ¥'] },
      { label: 'å¯¦éš›å·¥æ™‚',       keys: ['å¯¦éš›å·¥æ™‚','å·¥æ™‚','ç¸½å·¥æ™‚','å¯¦åšå·¥æ™‚'] },

      { label: 'å®Œå·¥æ•¸',         keys: ['å®Œå·¥æ•¸','ç”¢å‡ºæ•¸','æ•¸é‡'] },
      { label: 'ä¸è‰¯æ•¸',         keys: ['ä¸è‰¯æ•¸','ä¸è‰¯å“æ•¸','ä¸è‰¯'] },
      { label: 'é™¤å¤–åç¨±1',      keys: ['é™¤å¤–åç¨±1','é™¤å¤–1','é™¤å¤–åç¨±ä¸€'] },
      { label: 'é™¤å¤–æ™‚é–“1',      keys: ['é™¤å¤–æ™‚é–“1','é™¤å¤–æ™‚æ•¸1','é™¤å¤–æ™‚é–“ä¸€'] },

      { label: 'é™¤å¤–åç¨±2',      keys: ['é™¤å¤–åç¨±2','é™¤å¤–2','é™¤å¤–åç¨±äºŒ'] },
      { label: 'é™¤å¤–æ™‚é–“2',      keys: ['é™¤å¤–æ™‚é–“2','é™¤å¤–æ™‚æ•¸2','é™¤å¤–æ™‚é–“äºŒ'] },
      { label: 'é™¤å¤–åç¨±3',      keys: ['é™¤å¤–åç¨±3','é™¤å¤–3','é™¤å¤–åç¨±ä¸‰'] },
      { label: 'é™¤å¤–æ™‚é–“3',      keys: ['é™¤å¤–æ™‚é–“3','é™¤å¤–æ™‚æ•¸3','é™¤å¤–æ™‚é–“ä¸‰'] },
    ];

    // å„²å­˜ä½¿ç”¨è€…è¼¸å…¥çš„ä¿®æ”¹å€¼
    const edits = new Map();

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      alert.className = `alert alert-${type} show`;
      alert.textContent = message;
      setTimeout(() => alert.classList.remove('show'), 5000);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }

    async function searchData(event) {
      event.preventDefault();

      const dySerialNum = document.getElementById('dySerialNum').value.trim();
      if (!dySerialNum) {
        showAlert('è«‹è¼¸å…¥ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿ', 'error');
        return;
      }

      showLoading(true);
      
      // ä¸è¦éš±è—æ•´å€‹ resultSectionï¼Œåªéš±è—æŸ¥è©¢çµæœçš„éƒ¨åˆ†
      // document.getElementById('resultSection').style.display = 'none';

      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dySerialNum }),
        });

        const result = await response.json();
        if (result.success) {
          currentData = result.data;
          edits.clear();
          document.getElementById('deleteFlag').checked = false;
          
          // èª¿è©¦ï¼šé¡¯ç¤ºæŸ¥è©¢åˆ°çš„è³‡æ–™
          console.log('=== æŸ¥è©¢åˆ°çš„è³‡æ–™ ===');
          console.log('å®Œæ•´è³‡æ–™:', result.data[0]);
          console.log('æ‰€æœ‰ keys:', Object.keys(result.data[0]));
          console.log('====================');
          
          // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å¤©çš„ç”Ÿç”¢æ—¥å ±è¡¨
          if (result.data && result.data.length > 0) {
            const workDate = getValue(result.data[0], ['å·¥ä½œæ—¥æœŸ', 'æ—¥æœŸ']);
            console.log('å¾è³‡æ–™ä¸­å–å¾—çš„å·¥ä½œæ—¥æœŸ:', workDate);
            currentDateType = isSameDay(workDate) ? 'same_day' : 'different_day';
            
            // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            updateButtonVisibility(currentDateType);
          }
          
          displayResults(result.data);
          
          // é¡¯ç¤ºæç¤ºè¨Šæ¯
          const dateTypeText = currentDateType === 'same_day' ? 'ç•¶å¤©ä¿®æ”¹ï¼ˆä¸éœ€ç°½æ ¸ï¼‰' : 'éç•¶å¤©ä¿®æ”¹ï¼ˆéœ€ä¸»ç®¡ç°½æ ¸ï¼‰';
          showAlert(`æŸ¥è©¢æˆåŠŸï¼å…±æ‰¾åˆ° ${result.count} ç­†è³‡æ–™ - ${dateTypeText}`, 'success');
          
          updateQueueStatus();
        } else {
          // æŸ¥è©¢å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          showAlert(result.message, 'error');
          
          // ç¢ºä¿ resultSection ä»ç„¶é¡¯ç¤ºï¼ˆä¿ç•™ä¿®æ”¹ç”³è«‹æ¸…å–®ï¼‰
          const resultSection = document.getElementById('resultSection');
          if (resultSection) {
            resultSection.style.display = 'block';
          }
          
          // éš±è—æŸ¥è©¢çµæœç›¸é—œçš„å€åŸŸ
          const resultHeader = document.querySelector('.result-header');
          const deleteSection = document.querySelector('.delete-section');
          const cardsContainer = document.getElementById('cardsContainer');
          const saveBtn = document.getElementById('saveBtn');
          
          if (resultHeader) resultHeader.style.display = 'none';
          if (deleteSection) deleteSection.style.display = 'none';
          if (cardsContainer) cardsContainer.innerHTML = '';
          if (saveBtn) saveBtn.style.display = 'none';
          
          // ç¢ºä¿ä¿®æ”¹ç”³è«‹æ¸…å–®å’ŒæŒ‰éˆ•ä»ç„¶å¯è¦‹
          // æ›´æ–°æ¸…å–®ç‹€æ…‹ï¼ˆé¡¯ç¤ºå·²å„²å­˜çš„è¨˜éŒ„ï¼‰
          await updateQueueStatus();
          
          // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
          await updateButtonVisibility();
        }
      } catch (error) {
        showAlert('æŸ¥è©¢å¤±æ•—ï¼š' + error.message, 'error');
        
        // æŸ¥è©¢ç•°å¸¸æ™‚ä¹Ÿè¦ä¿æŒä¿®æ”¹ç”³è«‹æ¸…å–®å¯è¦‹
        const resultSection = document.getElementById('resultSection');
        if (resultSection) {
          resultSection.style.display = 'block';
        }
        
        // éš±è—æŸ¥è©¢çµæœå€åŸŸ
        const resultHeader = document.querySelector('.result-header');
        const deleteSection = document.querySelector('.delete-section');
        const cardsContainer = document.getElementById('cardsContainer');
        const saveBtn = document.getElementById('saveBtn');
        
        if (resultHeader) resultHeader.style.display = 'none';
        if (deleteSection) deleteSection.style.display = 'none';
        if (cardsContainer) cardsContainer.innerHTML = '';
        if (saveBtn) saveBtn.style.display = 'none';
        
        // ç¢ºä¿ä¿®æ”¹ç”³è«‹æ¸…å–®å’ŒæŒ‰éˆ•ä»ç„¶å¯è¦‹
        await updateQueueStatus();
        await updateButtonVisibility();
      } finally {
        showLoading(false);
      }
    }

    function getValue(row, keys, format) {
      let v = '';
      for (const k of keys) {
        if (row && row[k] != null && String(row[k]).trim() !== '') {
          v = row[k];
          break;
        }
      }
      if (format === 'hours2') {
        const num = Number(v);
        if (!Number.isFinite(num)) return v || '';
        return num.toFixed(2);
      }
      return v == null ? '' : String(v);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function displayResults(data) {
      document.getElementById('recordCount').textContent = data.length;
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';

      data.forEach((row, rowIndex) => {
        const card = document.createElement('div');
        card.className = 'prs-card';
        card.innerHTML = `<div class="prs-card-body"></div>`;

        const body = card.querySelector('.prs-card-body');
        const section = document.createElement('div');
        section.className = 'prs-section';
        section.innerHTML = `<div class="prs-grid prs-grid-4x6"></div>`;
        const grid = section.querySelector('.prs-grid');

        FIELDS.forEach((f) => {
          const value = getValue(row, f.keys, f.format);
          const editable = EDITABLE_LABELS.has(f.label);
          const editKey = `${rowIndex}::${f.label}`;
          const currentEdit = edits.get(editKey) || '';

          const item = document.createElement('div');
          item.className = 'prs-item';

          item.innerHTML = `
            <div class="prs-label">${escapeHtml(f.label)}</div>
            <div class="prs-value ${currentEdit ? 'prs-focus' : ''}">${escapeHtml(value || '')}</div>
            ${editable ? `<input class="prs-input" data-editkey="${escapeHtml(editKey)}" placeholder="å¯è¼¸å…¥ä¿®æ”¹å€¼" value="${escapeHtml(currentEdit)}" />` : `<div class="prs-input prs-input-disabled"></div>`}
          `;

          grid.appendChild(item);
        });

        body.appendChild(section);
        container.appendChild(card);
      });

      // ç¶å®š input äº‹ä»¶
      container.oninput = (e) => {
        const t = e.target;
        if (!(t instanceof HTMLInputElement)) return;
        if (!t.classList.contains('prs-input')) return;
        const editKey = t.getAttribute('data-editkey');
        if (!editKey) return;

        const v = t.value;
        if (v && v.trim() !== '') edits.set(editKey, v);
        else edits.delete(editKey);

        const item = t.closest('.prs-item');
        if (!item) return;
        const valueEl = item.querySelector('.prs-value');
        if (!valueEl) return;
        valueEl.classList.toggle('prs-focus', !!(v && v.trim() !== ''));
      };

      document.getElementById('resultSection').style.display = 'block';
      
      // é‡æ–°é¡¯ç¤ºæ‰€æœ‰å€åŸŸï¼ˆå¯èƒ½åœ¨å„²å­˜å¾Œè¢«éš±è—ï¼‰
      const resultHeader = document.querySelector('.result-header');
      const deleteSection = document.querySelector('.delete-section');
      const actionButtons = document.querySelector('.action-buttons');
      const saveBtn = document.getElementById('saveBtn');
      
      if (resultHeader) resultHeader.style.display = 'flex';
      if (deleteSection) deleteSection.style.display = 'block';
      if (actionButtons) actionButtons.style.display = 'flex';
      if (saveBtn) saveBtn.style.display = 'inline-block';  // é‡æ–°é¡¯ç¤ºã€Œå„²å­˜ã€æŒ‰éˆ•
    }

    function handleDeleteToggle() {
      const deleteChecked = document.getElementById('deleteFlag').checked;
      const inputs = document.querySelectorAll('.prs-input:not(.prs-input-disabled)');
      
      inputs.forEach(input => {
        input.disabled = deleteChecked;
        if (deleteChecked) {
          input.style.opacity = '0.5';
          input.style.cursor = 'not-allowed';
        } else {
          input.style.opacity = '1';
          input.style.cursor = 'text';
        }
      });
    }

    async function saveModification() {
      if (!currentData || currentData.length === 0) {
        showAlert('è«‹å…ˆæŸ¥è©¢è³‡æ–™', 'error');
        return;
      }

      const deleteFlag = document.getElementById('deleteFlag').checked ? 'æ˜¯' : 'å¦';
      
      // æ”¶é›†ä¿®æ”¹è³‡è¨Š
      const firstRow = currentData[0];
      
      // å…ˆå–å¾—å·¥ä½œæ—¥æœŸï¼ˆç”¨æ–¼åˆ¤æ–·ç•¶å¤©/éç•¶å¤©ï¼‰
      const workDateValue = getValue(firstRow, ['å·¥ä½œæ—¥æœŸ', 'æ—¥æœŸ', 'work_date', 'å·¥ä½œæ—¥']);
      console.log('å–å¾—çš„å·¥ä½œæ—¥æœŸï¼ˆç”¨æ–¼åˆ¤æ–·ï¼‰:', workDateValue);
      
      const modification = {
        dy_serial_num: getValue(firstRow, ['ç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿ']),
        pd_num: getValue(firstRow, ['ç™¼å·¥å–®è™Ÿ']),
        delete_flag: deleteFlag,
        work_date_original: workDateValue || '',  // æ·»åŠ å·¥ä½œæ—¥æœŸ
      };

      // å¦‚æœå‹¾é¸åˆªé™¤ï¼Œä¹Ÿéœ€è¦å·¥ä½œæ—¥æœŸä¾†åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å¤©
      
      if (deleteFlag === 'å¦') {
        // æ”¶é›†æ‰€æœ‰ä¿®æ”¹å€¼
        const fieldMapping = {
          'å·¥ä½œæ—¥æœŸ': 'work_date',
          'å·¥ä½œè€…ç·¨è™Ÿ': 'worker_num',
          'æ©Ÿå°ç·¨è™Ÿ': 'machine_num',
          'å·¥åºç·¨è™Ÿ': 'prod_num',
          'å®Œå·¥æ•¸': 'finish_qty',
          'ä¸è‰¯æ•¸': 'bad_qty',
          'èµ·å·¥æ™‚é–“': 'start_time',
          'å®Œå·¥æ™‚é–“': 'finish_time',
          'é™¤å¤–åç¨±1': 'extra_name1',
          'é™¤å¤–æ™‚é–“1': 'extra_time1',
          'é™¤å¤–åç¨±2': 'extra_name2',
          'é™¤å¤–æ™‚é–“2': 'extra_time2',
          'é™¤å¤–åç¨±3': 'extra_name3',
          'é™¤å¤–æ™‚é–“3': 'extra_time3',
        };

        for (const [label, key] of Object.entries(fieldMapping)) {
          const editKey = `0::${label}`;
          
          // ç‰¹æ®Šè™•ç†å·¥ä½œæ—¥æœŸï¼šä½¿ç”¨æ›´å¤šå¯èƒ½çš„æ¬„ä½åç¨±
          let originalValue;
          if (label === 'å·¥ä½œæ—¥æœŸ') {
            originalValue = workDateValue || '';
          } else {
            originalValue = getValue(firstRow, FIELDS.find(f => f.label === label)?.keys || []);
          }
          
          const modifiedValue = edits.get(editKey) || '';
          
          modification[`${key}_original`] = originalValue;
          modification[`${key}_modified`] = modifiedValue;
        }
      }

      showLoading(true);

      // èª¿è©¦ï¼šé¡¯ç¤ºå‚³é€çš„è³‡æ–™
      console.log('=== å„²å­˜çš„ä¿®æ”¹è³‡æ–™ ===');
      console.log('å®Œæ•´è³‡æ–™:', modification);
      console.log('å·¥ä½œæ—¥æœŸ original:', modification.work_date_original);
      console.log('å·¥ä½œæ—¥æœŸ modified:', modification.work_date_modified);
      console.log('====================');

      try {
        const response = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(modification),
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.message, 'success');
          
          // æ¸…ç©ºæ‰€æœ‰ç‹€æ…‹
          edits.clear();
          currentData = [];
          document.getElementById('deleteFlag').checked = false;
          
          // éš±è—æŸ¥è©¢çµæœå¡ç‰‡å€åŸŸï¼ˆä½†ä¿ç•™ä¿®æ”¹ç”³è«‹æ¸…å–®ï¼‰
          document.getElementById('cardsContainer').innerHTML = '';
          document.querySelector('.result-header').style.display = 'none';
          document.querySelector('.delete-section').style.display = 'none';
          
          // éš±è—ã€Œå„²å­˜ã€æŒ‰éˆ•ï¼ˆå› ç‚ºå·²ç¶“å„²å­˜äº†ï¼‰
          document.getElementById('saveBtn').style.display = 'none';
          
          // ä½†ä¿ç•™ã€Œä¸Šå‚³ã€å’Œã€Œåˆ—å°ã€æŒ‰éˆ•å€åŸŸï¼Œè®“ä½¿ç”¨è€…å¯ä»¥æ“ä½œ
          // ä¸è¦éš±è— .action-buttons
          
          console.log('[å„²å­˜æˆåŠŸ] æº–å‚™æ›´æ–°æŒ‰éˆ•é¡¯ç¤º...');
          
          // æ›´æ–°æ¸…å–®ç‹€æ…‹
          await updateQueueStatus();
          
          console.log('[å„²å­˜æˆåŠŸ] æ¸…å–®ç‹€æ…‹å·²æ›´æ–°ï¼Œç¾åœ¨æ›´æ–°æŒ‰éˆ•...');
          
          // ç«‹å³æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
          await updateButtonVisibility();
          
          console.log('[å„²å­˜æˆåŠŸ] æŒ‰éˆ•é¡¯ç¤ºå·²æ›´æ–°');
          
          // æ¸…ç©ºç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿè¼¸å…¥æ¬„ä½
          document.getElementById('dySerialNum').value = '';
        } else {
          showAlert(result.message, 'error');
        }
      } catch (error) {
        showAlert('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function uploadFiles() {
      showLoading(true);

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.message, 'success');
          // æ›´æ–°ä¿®æ”¹ç”³è«‹æ¸…å–®ç‹€æ…‹
          await updateQueueStatus();
          // å»¶é²å¾Œæ›´æ–°æŒ‰éˆ•é¡¯ç¤º
          setTimeout(async () => {
            await updateButtonVisibility();
          }, 100);
          
          // æ¸…ç©ºç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿè¼¸å…¥æ¬„ä½
          document.getElementById('dySerialNum').value = '';
        } else {
          showAlert(result.message, 'error');
        }
      } catch (error) {
        showAlert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function printQueue() {
      showLoading(true);

      try {
        const response = await fetch('/api/print', {
          method: 'POST',
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.message, 'success');
          
          // é–‹å•Ÿåˆ—å°é é¢ï¼ˆåªåŒ…å«éç•¶å¤©è¨˜éŒ„ï¼‰
          if (result.print_urls && result.print_urls.length > 0) {
            const printWindow = window.open(result.print_urls[0], '_blank');
            
            if (printWindow) {
              // åˆ—å°é é¢é–‹å•Ÿå¾Œï¼Œæ›´æ–°æ¸…å–®å’ŒæŒ‰éˆ•
              setTimeout(async () => {
                await updateQueueStatus();
                await updateButtonVisibility();
                
                // æ¸…ç©ºç”Ÿç”¢æ—¥å ±è¡¨åºè™Ÿè¼¸å…¥æ¬„ä½
                document.getElementById('dySerialNum').value = '';
              }, 500);
            }
          }
        } else {
          showAlert(result.message, 'error');
        }
      } catch (error) {
        showAlert('åˆ—å°å¤±æ•—ï¼š' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function clearQueue() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºåˆ—å°æ¸…å–®å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch('/api/clear_queue', {
          method: 'POST',
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.message, 'success');
          await updateQueueStatus();
          // å»¶é²å¾Œæ›´æ–°æŒ‰éˆ•é¡¯ç¤º
          setTimeout(async () => {
            await updateButtonVisibility();
          }, 100);
        } else {
          showAlert(result.message, 'error');
        }
      } catch (error) {
        showAlert('æ¸…ç©ºå¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    async function updateQueueStatus() {
      try {
        const response = await fetch('/api/get_queue_status');
        const result = await response.json();
        
        if (result.success) {
          const count = result.queue_count;
          const queue = result.queue || [];
          
          // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          document.getElementById('printBtn').disabled = (count === 0);
          
          // æ›´æ–°åˆ—å°æ¸…å–®é¡¯ç¤º
          const queueSection = document.getElementById('printQueueSection');
          const queueList = document.getElementById('queueList');
          
          if (count === 0) {
            queueSection.style.display = 'none';
          } else {
            queueSection.style.display = 'block';
            
            // ç”Ÿæˆåˆ—è¡¨é …ç›®
            queueList.innerHTML = queue.map((item, index) => `
              <div class="queue-item">
                <span class="queue-item-number">${index + 1}.</span>
                <span class="queue-item-serial">${item.dy_serial_num || 'æœªçŸ¥'}</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteQueueItem(${index})" title="å–®ç­†åˆªé™¤">
                  âŒ å–®ç­†åˆªé™¤
                </button>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('æ›´æ–°æ¸…å–®ç‹€æ…‹å¤±æ•—:', error);
      }
    }

    async function deleteQueueItem(index) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜éŒ„å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch('/api/delete_queue_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ index: index })
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.message, 'success');
          updateQueueStatus();
        } else {
          showAlert(result.message, 'error');
        }
      } catch (error) {
        showAlert('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
      }
    }

    // é é¢è¼‰å…¥æ™‚æ›´æ–°æ¸…å–®ç‹€æ…‹å’ŒæŒ‰éˆ•é¡¯ç¤º
    window.addEventListener('load', function() {
      updateQueueStatus();
      updateButtonVisibility();
    });

    // å®šæœŸæ›´æ–°æ¸…å–®ç‹€æ…‹å’ŒæŒ‰éˆ•ï¼ˆæ¯5ç§’ï¼‰
    setInterval(function() {
      updateQueueStatus();
      updateButtonVisibility();
    }, 5000);
  
    // Keep EXE alive while the page is open (heartbeat)
    const __prsHeartbeat = () => {
      fetch('/api/heartbeat', { method: 'POST', cache: 'no-store', keepalive: true })
        .catch(() => {});
    };
    __prsHeartbeat();
    setInterval(__prsHeartbeat, 3000);

    // Best-effort: close backend when tab/window is closed
    const __prsShutdown = () => {
      try {
        navigator.sendBeacon('/shutdown', '');
      } catch (e) {
        fetch('/shutdown', { method: 'POST', keepalive: true }).catch(() => {});
      }
    };
    window.addEventListener('pagehide', __prsShutdown);
    window.addEventListener('beforeunload', __prsShutdown);

  </script>
</body>
</html>
